# 第3章 数据链路层

## 3.1 数据链路层功能概述

### 数据链路层的基本概念

- 结点：主机、路由器；
- 链路：网络中两个结点之间的物理通道，链路的传输介质主要有双绞线、光纤和微波。分为有线链路、无线链路；
- 数据链路：网络中两个结点之间的逻辑通道，把实现控制数据传输协议的硬件和软件加到链路上就构成数据链路；
- 帧：链路层的协议数据单元，封装网络层的数据报。

数据链路层负责通过一个链路从一个结点向另一个物理链路直接相连的相邻结点传送数据报；

### 数据链路层的功能概述

- 数据链路层在物理层提供服务的基础上向网络层提供服务，最基本的服务是将源自网络层的数据可靠地传输到相邻节点的目标机网络层。
- 其主要作用是加强物理层传输原始比特流的功能；
- 将物理层提供的可能出错的物理连接改成为逻辑上无差错的数据链路，使之对网络层表现为一条无差错的链路；

> 我的理解：网络层需要互相通信时，希望使用物理层发送信息，但是物理层是容易出错的，所以增加数据链路层进行管理，但是对网络层来说，看起来只是物理层很好的完成了工作，形成无差错的链路连接；

数据链路层的功能：

- 功能一：为网络层提供服务（有确认-->接收段收到信息会发送提升给发送方）：
    - 无确认无连接服务；
    - 有确认无连接服务；
    - 有确认面对连接服务
    - 有连接一定有确认，所以没有无确认面对连接服务；
- 功能二：链路管理，即连接的建立、维持、释放（用于面向连接的服务）；
- 功能三：组帧；
- 功能四：流量控制；
- 功能五：差错控制（帧错/位错）；

​	接下来详细讲解功能；



## 3.2 封装成帧和透明传输

### 封装成帧

封装成帧：在一段数据的前后添加尾部与首部，这样就构成了一个帧。

接收端在收到物理层上交的比特流后，就可以根据首部与尾部的标记，从收到的比特流中识别帧的开始与结束；首部与尾部包含了很多控制信息，其中一个重要作用：帧定界（确定帧的界限）；

帧同步：接收方应当可以在接收到的二进制比特流中区分出帧的起始于终止；

### 透明传输

透明传输：不管所传输的数据是什么样的比特组合，都应该可以在链路上传输。因此，链路层就看不见有什么妨碍数据传输的东西；

当所传数据中的比特组合刚好与某一个控制信息完全一致，就必须采取适合的措施，使得接收方不会将这样的数据误认为控制信息，这样才能保证数据链路层的传输是透明的；

### 组帧方法

组帧的四种方法：

- 字符计数法：

    - 规则：帧首部使用一个计数字段（第一个字节，8bits）来标明帧内字符数n，紧随其后的n个字节为信息；之后就是下一个的帧首；
    - 缺点：一旦某个帧首部出错，那么之后的所有帧都会出错；

- 字符填充法：

    - 引入：考虑这样的组帧方式：

        帧由三个部分组成：一个字节的帧首部（SOH）、数据、一个字节的帧尾部（EOT）；当接收端口受到帧首部，就知道开始读取数据，接收到帧尾部就知道此帧结束了；至于帧首与帧尾用什么比特序列规定，在不同的协议中有不同的规定：比如 SOH 为 00000001，EOT为 00000100；		

    - 缺点：数据中不能有与 SOH 与 EOT 相同的比特序列；

    - 解决方法：使用字符填充法：

    - 在数据中的与 SOH 与 EOT 比特序列相同的字节前加入一个 ESC 转义字符，当读取到 ESC 时，就默认 ESC 的下一个一定是数据，同时原始数据中与 ESC 比特序列相同的也在前面加 ESC；这样就可以区别是有效数据还是帧头帧尾；

- 零比特填充法：

    - 引入：考虑这样的组帧方式：

        将 SOH 与 EOT 都定义为 01111110 用来给接收端检测帧的开始与结束，但是如何解决数据中也出现 01111110 的情况呢？ 使用零比特填充法：

    - 实现过程：

        - 发送端：扫描整个信息字段，只要找到五个连续的1，就立刻在其之后添加1一个0；之后再给每笔数据加上  01111110 的帧头与帧尾巴；
        - 接收端：接收端先找到标志字段：01111110 确定边界，再用硬件对其扫描，只要发现来连续5个1出现，就把其后面的0删除；

    - 这样由于在接收端还没去0时，数据段由于被处理过，不可能出现连续5个以上的1，那么就可以区分帧头与帧尾了，然后确定其中的数据，最后再还原；

- 违规编码法：

    - 规则：假如我们时候曼彻斯特编码处理我们的发出的数据，编码规定1发出先高后低的电平，0发出先低后高；那么就使用“高-高”与”低-低“来确定帧头尾；



## 3.3 差错控制（检错编码）

### 差错的由来

传输中的差错都是由噪声引起的；

- 全局性噪声：线路本身的电气特性产生的随机噪声；	

    解决方法：提高信噪比；

- 局部性噪声：外界特定的短暂原因造成的冲激噪声，是产生差错的主要原因

    解决办法：编码技术解决；

差错可以分为：

- 位错：比特位出错：1变0，0变1；
- 帧错：
    - 丢失；
    - 重复；
    - 失序；

### 数据链路层的差错控制

主要解决比特错，位错；

使用的方法：

- 检错编码：
  
    - 奇偶校验码：
        - 分为奇数校验码与偶数校验码，整个数据由n个比特组成，其中第一位是校验元，后n-1位为信息元；
        - 奇校验：计算信息元中 1 的个数是奇数还是偶数，然后使用校验元去使得整个n位数中的1为奇数个；
        - 偶校验：计算信息元中 1 的个数是奇数还是偶数，然后使用校验元去使得整个n位数中的1为偶数个；
        - 接收端判断n比特中1 的个数是否满足奇/偶数（使用奇校验/使用偶校验）来判断是否出错；
        - 缺点：发送错误个数如果是偶数就无法检测，检错概率只有50%；
    - 循环冗余码CRC：
        - 接收端与发送端规定好一个比特序列称为生成多项式；
        - 发送段把要发送的数据先除生成多项式后得到一个余数称为冗余码；
        - 把要发送的数据加上冗余码后再发送出去；
        - 接收端判断接收到的数据是否可以整除生成多项式，如果可以就表示没有出错；
        - 计算冗余码的方法：
            - ...不考研，不做了解
    
- 纠错编码：
  
    - 海明码：（发现双比特错，纠正单比特错）
    
        - 工作原理：动一发而牵全身，一个位出错，会使得多个校验码发现错误；
    
        - 工作流程；
    
            - 1、确定校验码位数r，使用海明不等式：
    
            $$
            2^r \ge k + r + 1
            $$
    
            ​	    r 为冗余信息，k为信息位（数据位）；
    
            - 2、确定校验码和数据的位置
    
                对  k 位数据插入 r 位校验码（由1中海明不等式计算得来），那么一共有 k + r bit；
    
                先把校验码插入到 2 的n次方位的位置（下标从1开始，n从0开始，即第一位bit插入第一个校验码），剩下的空位插入数据（此时还不知道校验码到底写入什么值，只是确定其位置）；
    
            - 3、求出校验码的值
    
                对一个位于 2^n 次方位置的校验码，要使得所有下标中第n位（下标要写为二进制形式）为1的数据以及次校验码异或的值为0，就可得到位于下标为 2^n 的校验码的值；
    
                比如，第一个校验码位于 2^0 位置，那么要求所有下标第0位为1的数据位与该校验码异或后为0，也即对位于第 0011、0101、0111、1001……的下标的这些数据；
    
            - 4、检错并纠错
    
                令所有要校验的位作异或运算，也就是 3 中求校验码的那些数据再异或，判断是否有数据出错；



## 3.4 流量控制与可靠传输机制

### 数据链路层的流量控制

较高的发送速度与较低的接收能力不匹配，会造成传输出错，因此流量控制是数据链路层的一项重要工作；

数据链路层的流量控制是点对点的，而传输层的流量控制是端到端的；

数量链路层流量控制手段：接收方收不下就不回复确认；

传输层流量控制手段：接收端给发送端一个窗口公告；

### 流量控制的方法

- 停止-等待协议
    - 规则：每次发送完一个帧就停止发送，等待对方的确认，收到确认后再发送下一个；
- 滑动窗口协议
    - 后退N帧协议（GBN）
    - 选择重传协议（SR）

### 可靠传输、滑动窗口、流量控制

- 可靠传输：发送端发送什么，接收端就接收什么；
- 流量控制：控制发送速率，使接收方有足够的缓冲空间来接收每一个帧；
- 滑动窗口解决：
    - 流量控制（收不下就不给确认，想发也发不了）
    - 可靠传输（发送端自动重传）



## 3.4 停-等待协议

### 停止等待协议

- 为什么需要停止-等待协议：
    - 除了比特出差错，底层信道还会出现丢包问题；为了实现流量控制；
- 研究停止-等待协议的前提：
    - 虽然一般都在全双工通信方式，但是为了方便，仅仅考虑一方发送一方接收的情况；
- 停止-等待的应用情况：
    - 无差错情况；
    - 有差错情况；

### 停等协议——无差错情况

​	

### 停等协议——有差错情况

- 数据帧丢失或检测到帧出错，那么如果发送端一直等待就永远等不到：
    - 解决方法：使用超时计时器：每次放送一个帧就启动一个计时器；超过计时器设置的重传时间应当比帧传输的平均RTT更长一些；
    - 注意：
        - 发送完一个帧后，必须保留它的副本；
        - 数据帧和确认帧必须编号；
- ACK（确定帧）丢失

### 停止等待协议性能分析

- 信道利用率太低：往返时延太久了，大部分都在等待，而不是发送数据；

​	ps（信道利用率是发送方在一个发送周期内，有效地发送数据据所需要的时间占整个发送周期的比率）



## 3.5 后退N帧协议

停止等待协议信道利用率太低，使用流水线技术；为了实现流水线，我们需要有以下之一的条件：

​	1、必须增加序号范围；

​	2、发送方需要缓存多个分组；

而后退N帧协议（GBN）与选择重传协议（SR）就分别对应着这两种解决方法；

### 后退N帧协议中的滑动窗口

发送窗口：发送方维持一组连续的允许发送的帧的序号；

接收窗口：接收方维持一组连续的允许接的收帧的序号；

在停止等待协议中，两个窗口大小都相当于为1，而后退N帧协议的发送窗口有多个；

在发送方中的帧可以分为：

- 已经发送并且已经收到了接收方的ACK确认；
- 已经发送还没收到ACK确认；
- 还没发送，但位于滑动窗口内部，可以发送的数据；
- 还没发送，但位于滑动窗口外部，不可以发送的数据；

### GBN发送方必须响应的三件事

- 上层（网络层）的调用

    上层要发送数据时，发送方先检查发送窗口是否已满，如果未满，则产生一个帧并将其发送；如果窗口已满，发送方只需要将数据再返回上层，暗示上层窗口已满。上层等一会再发（实际中，发送方可以缓存这些数据，窗口不满时再发送帧）；

- 收到了一个ACK

    GBN协议中，对n号帧的确认采用累计确认的方式，标明接受方已经收到n号帧和它之前的全部帧；

- 超时事件

    协议的名字为后退N帧协议，来源于出现丢失和时延过长帧时发送方的行为。就像停等协议中一样，定时器将再次用于恢复数据帧或确认帧的丢失。如果出现超时，发送方重传所有已发送但未被确认的帧；

### GBN接收方要做的事

- 如果正确收到n号帧，并且按序，那么接收方为 n 帧发送一个 ACK，并将该帧中的数据部分交付给上层；
- 其余情况都丢帧，并为最近按序接收的帧重新发送 ACK。接收方无需缓存任何失序帧，只需要维护一个信号：expectedseqnum（下一个按序接收的帧序号）；

### 滑动窗口的长度

若采用n比特对帧编号，那么发送窗口的尺寸W满足 $1\le W_T\le 2^n -1$；因为发送窗口过大，就会使得接收方无法区别新帧和旧帧；

### GBN协议重点总结

- 累积确认（偶尔捎带确认）；
- 接收方只按顺序接收帧、不按序就丢弃；
- 确认序列号最大的、按序到达的帧；
- 发送窗口最大为 $2^n - 1$，接收窗口为1；



## 3.6 选择重传协议（SR）

### GBN 协议的弊端

累积确认，批量重传；

解决方法：设置单个确认，同时加大接收窗口，设置接收缓存、缓存乱序到达的帧；

### 选择重传协议的滑动窗口

过程比较复杂，将发送数据分成多个帧，并规定一个滑动窗口，每次都只能操作窗口内部的这些帧，需要发送方与接受方遵守以下协议，建议看视频，口头难以描述；

### SR发送方必须响应的三件事

- 上层的调用

    从上层收到数据后，SR发送方检查下一个可用于该帧的序号，如果序号位于发送窗口内，则发送数据帧；否则就像 GBN 一样，要么将数据缓存，要么返回给上层之后再传输；

- 收到一个ACK

    如果收到 ACK，加入该帧号在窗口内，则 SR 发送方将那个被确认的帧标记为已接收。如果该帧序号是窗口的下界（最左边第一个窗口对应的序号），则窗口向前移动到就具有最小序号的未确认帧处。如果窗口移动了并且有序号在窗口内的未发送帧，则发送这些帧；

- 超时事件

    每个帧都有自己的定时器，一个超时事件发送后只重传一个帧；

### SR接收方要做的事

- 来着不拒（窗口内的帧）

    SR 接收方将确认一个正在接收的帧而不管其是都按序。失序的帧将被缓存，并返回发送方一个该帧的确认帧，直到所有帧（即序号更小的帧）都被收到为止，这时才可以将一批帧按序交付给上层，然后向前移动滑动窗口；如果收到了窗口序号外（小于窗口下界）的帧，就返回一个 ACK；

### 滑动窗口的长度

- 发送窗口最好等于接收窗口（大了会溢出，小了没意义）；
- 通常滑动窗口的最大值为：

$$
W_{Tmax} = W_{Rmax} = 2^{n-1}
$$

​	其中 n 为 帧序号大小的 2 指数部分，比如 0 1 2 3 四个帧序号 n = 2；

### SR协议重点总结

- 对数据帧逐一确认，收一个确认一个；
- 只重传出错帧；
- 接收方有缓存；
- $W_{Tmax} = W_{Rmax} = 2^{n-1}$



## 3.7 信号划分介质访问控制

### 传输数据使用的两种链路

- 点对点链路
    - 两个相邻节点通过一个链路相连，没有第三者；
    - 应用：PPP协议、常用于广域网；
- 广播式链路
    - 所有主机共享通信介质；
    - 应用：早期的总线以太网、无线局域网、常用于局域网；
    - 典型拓扑结构：总线型、星型（逻辑总线型）；

### 介质访问控制

介质访问控制的内容就是：采取一定的措施，使得两对节点之间的通信不会发送互相干扰的情况；可以分为：

- 静态划分信道——信道划分介质访问控制；
    - 频分多路复用FDM；（Frequency）
    - 时分多路复用TDM；（Time）
    - 波分多路复用WDM；（Wave）
    - 码分多路复用CDM；（Code）
- 动态分配信号
    - 轮询访问介质访问控制——令牌传递协议；
    - 随机访问介质访问控制
        - ALOHA协议；
        - CSMA协议；
        - CSMA/CD协议；
        - CSMA/CA协议；

### 信号划分介质访问控制

信号划分介质访问控制：

将使用介质的每个设备与来自同一信道上的其他设备的通信隔离开，八时域和频域资源合理地分配给网络上的设备；

多路复用技术：

把多个信号组合在一条物理信道上进行传输，使得多个计算机或终端设备共享信道资源，提高信号利用率；

### 信道划分介质访问控制

- 频分多路复用 FDM

    用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。频分复用的所有用户在同样的时间占用不同的带宽（频率带宽）资源；

    充分利用传输介质带宽，系统效率较高；由于技术比较成熟，实现也容易；

- 时分多路复用 TDM

    将时间划分为一段段等长的时分复用帧（TDM帧），每一个时分复用的用户在每一个TDM帧中占用固定序号的时隙，所有用户轮流占用信号；

- 波分多路复用

    光的频率多路复用

- 码分多路复用

    
